rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =======================================================================
    // USERS COLLECTION
    // Users can read any user (for leaderboard)
    // Users can only update specific non-economy fields on their own document
    // Economy fields (score, streaks, power-ups) should only be modified by Cloud Functions
    // =======================================================================
    match /users/{userId} {
      allow read: if request.auth != null;
      
      // Allow creation of new user document
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Allow updates with HYPERSTREAK anti-cheat validation:
      // - hyper_bar must be <= 10 (HYPER_BAR_MAX)
      // - questions_in_hyper must be <= 5 (HYPER_DURATION_QUESTIONS)
      // Additional anti-cheat is enforced by Cloud Functions
      allow update: if request.auth != null && 
                      request.auth.uid == userId &&
                      // Hyperstreak anti-cheat rules
                      (request.resource.data.hyper_bar == null || request.resource.data.hyper_bar <= 10) &&
                      (request.resource.data.questions_in_hyper == null || request.resource.data.questions_in_hyper <= 5);
      
      // User's achievements subcollection
      match /achievements/{achievementId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Playtime tracking subcollection (for compliance)
      match /playtime/{weekId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // =======================================================================
    // QUESTIONS COLLECTION
    // Anyone authenticated can read questions
    // Anyone authenticated can create questions (costs points - validated in code)
    // Vote counts can be updated (transaction handles atomicity)
    // =======================================================================
    match /questions/{questionId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if false; // Questions cannot be deleted
    }
    
    // =======================================================================
    // VOTES COLLECTION
    // Votes are immutable once created
    // Used to prevent duplicate voting
    // =======================================================================
    match /votes/{voteId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && 
                      request.resource.data.uid == request.auth.uid;
      allow update, delete: if false;
    }
    
    // =======================================================================
    // SKIPS COLLECTION
    // Records skipped questions (from Skip power-up)
    // Prevents re-voting on skipped questions
    // =======================================================================
    match /skips/{skipId} {
      allow read: if request.auth != null;
      // Only Cloud Functions should create skips in production
      // Allow client creation during development
      allow create: if request.auth != null && 
                      request.resource.data.uid == request.auth.uid;
      allow update, delete: if false;
    }
    
    // =======================================================================
    // REWARD LOGS (Analytics)
    // Created by Cloud Functions only
    // Users can read their own logs
    // =======================================================================
    match /reward_logs/{logId} {
      allow read: if request.auth != null && 
                    resource.data.uid == request.auth.uid;
      // Only Cloud Functions (Admin SDK) can write
      allow write: if false;
    }
    
    // =======================================================================
    // STREAK FREEZE LOGS (Analytics)
    // Created by Cloud Functions only
    // Users can read their own logs
    // =======================================================================
    match /streak_freeze_logs/{logId} {
      allow read: if request.auth != null && 
                    resource.data.uid == request.auth.uid;
      // Only Cloud Functions (Admin SDK) can write
      allow write: if false;
    }
    
    // =======================================================================
    // HYPERSTREAK CHEAT LOGS (Analytics)
    // Created by Cloud Functions when cheating is detected
    // Only admins can read (not exposed to client)
    // =======================================================================
    match /hyperstreak_cheat_logs/{logId} {
      allow read: if false; // Only Admin SDK
      allow write: if false; // Only Cloud Functions
    }
    
    // =======================================================================
    // DAILY HOT TAKES COLLECTION
    // One document per day, same hot take question for all users
    // Read by all authenticated users
    // Only Cloud Functions/Admin can write
    // =======================================================================
    match /daily_hot_takes/{date} {
      allow read: if request.auth != null;
      // In dev mode, allow client writes for seeding
      // In production, only Cloud Functions (Admin SDK) should write
      allow write: if request.auth != null;
    }
    
  }
}
